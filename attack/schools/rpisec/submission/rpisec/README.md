# RPISEC submission for Mitre Embedded CTF

### Building:

In the `host_tools` directory, run

```sh
./fw_build
```

### Flashing:

In the `host_tools` directory,

After chip has been attached using `avr_dragon` and jtag run

```sh
./flash.sh
```

After flashing, reset and the chip will go into a configure mode.

### Configuring:

In the `host_tools` directory, run

```sh
./bl_configure --port <port>
```

where `port` is the port that the
chip's UART 1 is attached to, usually `/dev/ttyUSB0`.

This will create a file called `secret_configure_output.txt` which
will contain keys needed to readback and protect firmware.

After configuring, reset the devcie.

### Readback

Ensure UART 1 is attached to the device. Connect pin PB2 to ground.

Then in the `host_tools` directory, run

```sh
./readback --port <port> --address <start_address> --num-bytes <bytes>
```

where `port` is the location of UART1, `start_address` is the address
to start reading, and `bytes` is the number of bytes to output.

The tool will output cryptographic signatures and hashes used to securely
verify the encrypted data sent to the device, and finally decrypt the
data sent back.

### Firmware protecting

In the `host_tools` directory, run

```sh
./fw_protect --infile <unprotected_firmware> --outfile <protected_firmware> --version <version_number> --message <release_message>
```

where `unprotected_firmware` is firmware to be protected in intel hex
format, `protected_firmware` is where you want the firmware to go after
encryption, `version_number` is the version of your software release,
and `release_message` is your desired release message

### Firmware flashing

In the `host_tools` directory, run

```sh
./fw_update --port <port> --firmware <protected_firmware>
```

where `port` is the location of `UART1`, usually `/dev/ttyUSB0` if you have
one UART connection, and `protected_firmware` is the path to the
protected firmware blob generated by the `fw_protect` command.

After flashing, if you need to reset the device, hit the reset button
twice and wait a second in between resets.

